#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•ä¿®å¤åçš„æŸ¥è¯¢é¢„çº¦åŠŸèƒ½
"""

import json
import socket
import struct
from datetime import datetime, timedelta


def send_json_data(host, port, data):
    """å‘é€JSONæ•°æ®"""
    try:
        client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        client_socket.connect((host, port))
        
        json_str = json.dumps(data, ensure_ascii=False, indent=2)
        json_bytes = json_str.encode('utf-8')
        
        filename = "test_fixed.json"
        filename_bytes = filename.encode('utf-8')
        client_socket.sendall(struct.pack("!I", len(filename_bytes)))
        client_socket.sendall(filename_bytes)
        
        client_socket.sendall(struct.pack("!I", len(json_bytes)))
        client_socket.sendall(json_bytes)
        
        raw_response_len = client_socket.recv(4)
        if not raw_response_len:
            return None
        response_len = struct.unpack("!I", raw_response_len)[0]
        
        response_data = b""
        while len(response_data) < response_len:
            chunk = client_socket.recv(response_len - len(response_data))
            if not chunk:
                break
            response_data += chunk
        
        response_str = response_data.decode('utf-8')
        response = json.loads(response_str)
        
        client_socket.close()
        return response
        
    except Exception as e:
        print(f"âŒ è¿æ¥é”™è¯¯: {e}")
        return None


def test_query_by_patient():
    """æµ‹è¯•æŒ‰æ‚£è€…æŸ¥è¯¢"""
    print("=== ğŸ“± æŒ‰æ‚£è€…æ‰‹æœºå·æŸ¥è¯¢æµ‹è¯• ===")
    
    data = {
        "query_appointments": True,
        "patient_phone": "13800138000"  # å¼ ä¸‰
    }
    
    print("æŸ¥è¯¢å¼ ä¸‰çš„é¢„çº¦è®°å½•...")
    response = send_json_data('8.140.225.6', 55000, data)
    
    if response:
        print("ğŸ“¥ æœåŠ¡å™¨å“åº”:")
        if response.get('status') == 'success':
            appointments = response.get('appointments', [])
            message = response.get('message', '')
            
            print(f"âœ… {message}")
            
            if 'debug_info' in response:
                debug = response['debug_info']
                print(f"ğŸ” è¯Šæ–­ä¿¡æ¯: é¢„çº¦={debug['total_appointments']}, æ‚£è€…={debug['total_patients']}, åŒ»ç”Ÿ={debug['total_doctors']}")
            
            for i, apt in enumerate(appointments, 1):
                print(f"   {i}. ID={apt['appointment_id']}, åŒ»ç”Ÿ={apt['doctor_name']}, æ—¶é—´={apt['appointment_time'][:16]}")
                
        elif response.get('status') == 'error':
            print(f"âŒ æŸ¥è¯¢å¤±è´¥: {response.get('message')}")
        else:
            print(f"â“ æœªçŸ¥å“åº”: {response}")
    else:
        print("âŒ æœåŠ¡å™¨æ— å“åº”")
    
    print()


def test_query_by_doctor():
    """æµ‹è¯•æŒ‰åŒ»ç”ŸæŸ¥è¯¢"""
    print("=== ğŸ‘¨â€âš•ï¸ æŒ‰åŒ»ç”Ÿå§“åæŸ¥è¯¢æµ‹è¯• ===")
    
    data = {
        "query_appointments": True,
        "doctor_name": "ç‹åŒ»ç”Ÿ"
    }
    
    print("æŸ¥è¯¢ç‹åŒ»ç”Ÿçš„é¢„çº¦å®‰æ’...")
    response = send_json_data('8.140.225.6', 55000, data)
    
    if response:
        if response.get('status') == 'success':
            appointments = response.get('appointments', [])
            message = response.get('message', '')
            
            print(f"âœ… {message}")
            
            for i, apt in enumerate(appointments, 1):
                print(f"   {i}. æ‚£è€…={apt['patient_name']}, æ—¶é—´={apt['appointment_time'][:16]}, çŠ¶æ€={apt['status']}")
                
        elif response.get('status') == 'error':
            print(f"âŒ æŸ¥è¯¢å¤±è´¥: {response.get('message')}")
    else:
        print("âŒ æœåŠ¡å™¨æ— å“åº”")
    
    print()


def test_query_by_date():
    """æµ‹è¯•æŒ‰æ—¥æœŸæŸ¥è¯¢ï¼ˆé‡ç‚¹æµ‹è¯•DATEå‡½æ•°ä¿®å¤ï¼‰"""
    print("=== ğŸ“… æŒ‰æ—¥æœŸæŸ¥è¯¢æµ‹è¯• (DATEå‡½æ•°ä¿®å¤éªŒè¯) ===")
    
    # æµ‹è¯•ä»Šå¤©çš„æ—¥æœŸ
    today = datetime.now().strftime("%Y-%m-%d")
    
    data = {
        "query_appointments": True,
        "appointment_date": today
    }
    
    print(f"æŸ¥è¯¢ {today} çš„é¢„çº¦...")
    response = send_json_data('8.140.225.6', 55000, data)
    
    if response:
        if response.get('status') == 'success':
            appointments = response.get('appointments', [])
            message = response.get('message', '')
            
            print(f"âœ… {message}")
            
            for i, apt in enumerate(appointments, 1):
                print(f"   {i}. æ‚£è€…={apt['patient_name']}, åŒ»ç”Ÿ={apt['doctor_name']}, æ—¶é—´={apt['appointment_time']}")
                
        elif response.get('status') == 'error':
            error_msg = response.get('message', '')
            if "DATEå‡½æ•°é”™è¯¯" in error_msg:
                print(f"ğŸ”„ DATEå‡½æ•°é—®é¢˜å·²è‡ªåŠ¨å¤„ç†: {error_msg}")
            else:
                print(f"âŒ æŸ¥è¯¢å¤±è´¥: {error_msg}")
    else:
        print("âŒ æœåŠ¡å™¨æ— å“åº”")
    
    print()


def test_query_all():
    """æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰é¢„çº¦"""
    print("=== ğŸ“‹ æŸ¥è¯¢æ‰€æœ‰é¢„çº¦æµ‹è¯• ===")
    
    data = {
        "query_appointments": True
    }
    
    print("æŸ¥è¯¢æ‰€æœ‰é¢„çº¦è®°å½•...")
    response = send_json_data('8.140.225.6', 55000, data)
    
    if response:
        if response.get('status') == 'success':
            appointments = response.get('appointments', [])
            message = response.get('message', '')
            
            print(f"âœ… {message}")
            
            # åªæ˜¾ç¤ºå‰5æ¡
            for i, apt in enumerate(appointments[:5], 1):
                status_icon = {'pending': 'â³', 'completed': 'âœ…', 'cancelled': 'âŒ'}.get(apt['status'], 'â“')
                print(f"   {i}. {status_icon} {apt['patient_name']} â†’ {apt['doctor_name']}, {apt['appointment_time'][:16]}")
            
            if len(appointments) > 5:
                print(f"   ... è¿˜æœ‰ {len(appointments)-5} æ¡è®°å½•")
                
        elif response.get('status') == 'error':
            print(f"âŒ æŸ¥è¯¢å¤±è´¥: {response.get('message')}")
    else:
        print("âŒ æœåŠ¡å™¨æ— å“åº”")
    
    print()


def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("ğŸ”§ æŸ¥è¯¢é¢„çº¦SQLä¿®å¤éªŒè¯æµ‹è¯•")
    print("ğŸ“ æœåŠ¡å™¨: 8.140.225.6:55000")
    print("="*60)
    print()
    
    try:
        # 1. æŒ‰æ‚£è€…æŸ¥è¯¢
        test_query_by_patient()
        
        # 2. æŒ‰åŒ»ç”ŸæŸ¥è¯¢
        test_query_by_doctor()
        
        # 3. æŒ‰æ—¥æœŸæŸ¥è¯¢ï¼ˆDATEå‡½æ•°ä¿®å¤éªŒè¯ï¼‰
        test_query_by_date()
        
        # 4. æŸ¥è¯¢æ‰€æœ‰é¢„çº¦
        test_query_all()
        
        print("="*60)
        print("ğŸ‰ SQLä¿®å¤éªŒè¯æµ‹è¯•å®Œæˆï¼")
        print()
        print("ğŸ“Š ä¿®å¤è¦ç‚¹:")
        print("   âœ… DATE()å‡½æ•°å…¼å®¹æ€§é—®é¢˜å·²ä¿®å¤")
        print("   âœ… é”™è¯¯å¤„ç†æ›´åŠ è¯¦ç»†")
        print("   âœ… å¢åŠ äº†è¯Šæ–­ä¿¡æ¯")
        print("   âœ… ä½¿ç”¨INNER JOINç¡®ä¿è¡¨å…³è”")
        
    except KeyboardInterrupt:
        print("\nâ¹ï¸  æµ‹è¯•å·²ä¸­æ–­")
    except Exception as e:
        print(f"âŒ æµ‹è¯•å‡ºé”™: {e}")


if __name__ == "__main__":
    main()

